{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "appServiceName": {
            "type": "string",
            "metadata": {
                "description": "The name of the App Service"
            }
        },
        "appServicePlanName": {
            "type": "string",
            "metadata": {
                "description": "The sku of the App Service"
            }
        },
        "appServicePlanSku": {
            "type": "object",
            "metadata": {
                "description": "The sku of the App Service Plan"
            }
        },
        "appServicePlanRG": {
            "type": "string",
            "metadata": {
                "description": "Resource Group where the ASP lives"
            }
        },
        "nodeVersion": {
            "type": "string",
            "defaultValue": "12.9.0",
            "metadata": {
                "description": "The default NodeJS version that the App Service will run"
            }
        },
        "minTlsVersion": {
            "type": "string",
            "defaultValue": "1.0",
            "metadata": {
                "description": "The minimum tls version for the service"
            }
        },
        "numberOfWorkers": {
            "type": "int",
            "defaultValue": 1,
            "metadata": {
                "description": "The number of workers to assign to the app service within the app service plan"
            }
        },
        "appInsightsInstrumentationKey": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Required value for application service"
            }
        },
        "exclientBaseUrl": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
               "description": "Required value for application service"
            }
        },
        "samlSigningCert": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
               "description": "Required value for application service"
            }
        },
        "oidcHost": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
               "description": "Required value for application service"
            }
        },
        "redisConn": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
               "description": "Required value for application service"
            }
        },
        "samlSigningCertRsaPrivateKey": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
               "description": "Required value for application service"
            }
        },
        "secretKeyBase": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
               "description": "Required value for application service"
            }
        },
        "serviceID": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
               "description": "Required value for application service"
            }
        },
        "assertionsHost": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
               "description": "Required value for application service"
            }
        },
        "assertionsSecret": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
               "description": "Required value for application service"
            }
        },
        "profileHost": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
               "description": "Required value for application service"
            }
        },
        "identityURL": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
               "description": "Required value for application service"
            }
        }      
    },
    "variables": {
    },
    "resources": [
        {
            "apiVersion": "2017-05-10",
            "name": "[parameters('appServicePlanName')]",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/DFE-Digital/login.dfe.infrastructure/master/Shared/app-service-plan.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "appServicePlanName": {
                        "value": "[parameters('appServicePlanName')]"
                    },
                    "appServicePlanSku": {
                        "value": "[parameters('appServicePlanSku')]"
                    },
                    "appServicePlanOS": {
                        "value": "Linux"
                    },
                    "appServicePlanIsLinux": {
                        "value": true
                    }
                }
            }
        },
        {
            "apiVersion": "2017-05-10",
            "name": "[parameters('appServiceName')]",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
					"uri": "https://raw.githubusercontent.com/DFE-Digital/login.dfe.infrastructure/master/Shared/app-service-azure-config-extended.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "appServiceName": {
                        "value": "[parameters('appServiceName')]"
                    },
                    "appServicePlanName": {
                        "value": "[parameters('appServicePlanName')]"
                    },
                    "appServicePlanRG": {
                        "value": "[parameters('appServicePlanRG')]"
                    },
                    "nodeVersion": {
                        "value": "node|12.9"
                    },
                    "numberOfWorkers": {
                        "value": "[parameters('numberOfWorkers')]"
                    },
                    "minTlsVersion": {
                        "value": "[parameters('minTlsVersion')]"
                    },
                    "appInsightsInstrumentationKey": {
                        "value": "[parameters('appInsightsInstrumentationKey')]"
                    },
                    "exclientBaseUrl": {
                        "value": "[parameters('exclientBaseUrl')]"
                    },
                    "samlSigningCert": {
                        "value": "[parameters('samlSigningCert')]"
                    },
                    "oidcHost": {
                        "value": "[parameters('oidcHost')]"
                    },
                    "redisConn": {
                        "value": "[parameters('redisConn')]"
                    },
                    "samlSigningCertRsaPrivateKey": {
                        "value": "[parameters('samlSigningCertRsaPrivateKey')]"
                    },
                    "secretKeyBase": {
                        "value": "[parameters('secretKeyBase')]"
                    },
                    "serviceID": {
                        "value": "[parameters('serviceID')]"
                    },
                    "assertionsHost": {
                        "value": "[parameters('assertionsHost')]"
                    },
                    "assertionsSecret": {
                        "value": "[parameters('assertionsSecret')]"
                    },
                    "profileHost": {
                        "value": "[parameters('oidcHost')]"
                    },
                    "identityURL": {
                        "value": "[parameters('identityURL')]"
                    },
					"additionalAppSettings": {
                        "value": {
                            "APPINSIGHTS_INSTRUMENTATIONKEY": "[parameters('appInsightsInstrumentationKey')]",
							"BASE_URL": "[parameters('exclientBaseUrl')]",
							"CERT": "[parameters('samlSigningCert')]",
							"LANG": "en_US.UTF-8",
							"OIDC_CLIENT_ID": "EXCLIENT",
							"OIDC_CLIENT_SECRET": "exclient",
							"OIDC_HOST": "[parameters('oidcHost')]",
							"RACK_ENV": "production",
							"RAILS_ENV": "production",
							"RAILS_LOG_TO_STDOUT": "enabled",
							"RAILS_SERVE_STATIC_FILES": "enabled",
							"REDIS_URL": "[concat(parameters('redisConn'),'/6')]",
							"SECRET_KEY": "[parameters('samlSigningCertRsaPrivateKey')]",
							"SECRET_KEY_BASE": "[parameters('SecretKeyBase')]",
							"USE_TEST_IDP": "false",
							"SERVICE_ID":  "[parameters('serviceID')]",
							"ASSERTION_API": "[parameters('assertionsHost')]",
							"ASSERTION_API_SECRET": "[parameters('assertionsSecret')]",
							"SLO_URL": "[concat('https://',parameters('profileHost'),'/signout/')]",
							"SCM_DO_BUILD_DURING_DEPLOYMENT": "true",
							"IDENTITY_URL": "[parameters('identityURL')]", 
							"DISPLAY_XML": "false"
                        }
                    }	                    
				}   
        },
            "dependsOn": [
                "[parameters('appServicePlanName')]"
        ]
    }
    ],
	    "outputs": {
    }
	
}


